<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Attachments Module</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    h1 {
      color: #60a5fa;
    }
    button {
      background: #1e40af;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #2563eb;
    }
    #output {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #4ade80;
    }
    .error {
      color: #f87171;
    }
    .info {
      color: #60a5fa;
    }
    input[type="file"] {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª Test Attachments Module</h1>

  <div>
    <h2>1. Test basique</h2>
    <button onclick="testInit()">Init DB</button>
    <button onclick="testSave()">Save Test Blob</button>
    <button onclick="testGet()">Get Test Blob</button>
    <button onclick="testDelete()">Delete Test Blob</button>
    <button onclick="testList()">List All</button>
    <button onclick="testTotalSize()">Get Total Size</button>
  </div>

  <div>
    <h2>2. Test avec vrai fichier</h2>
    <input type="file" id="fileInput" />
    <button onclick="testUpload()">Upload File</button>
    <button onclick="testDownload()">Download Last</button>
  </div>

  <div>
    <h2>3. Garbage collection</h2>
    <button onclick="testCleanOrphans()">Clean Orphans</button>
  </div>

  <div>
    <h2>4. Utilitaires</h2>
    <button onclick="testAvailability()">Check Availability</button>
    <button onclick="testFormatSize()">Test Format Size</button>
    <button onclick="clearOutput()">Clear Output</button>
  </div>

  <div id="output"></div>

  <script type="module">
    import * as Attachments from './src/js/core/attachments.js';

    // Exposer les fonctions globalement pour les boutons
    window.Attachments = Attachments;
    window.lastAttachmentId = null;

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    window.testInit = async function() {
      try {
        await Attachments.initDB();
        log('âœ… IndexedDB initialized', 'success');
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testSave = async function() {
      try {
        const id = Attachments.generateAttachmentId();
        const blob = new Blob(['Hello, this is a test file!'], { type: 'text/plain' });
        await Attachments.saveAttachment(id, blob);
        window.lastAttachmentId = id;
        log(`âœ… Saved blob with ID: ${id}`, 'success');
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testGet = async function() {
      if (!window.lastAttachmentId) {
        log('âš ï¸ No attachment ID saved. Run "Save Test Blob" first.', 'error');
        return;
      }
      try {
        const blob = await Attachments.getAttachment(window.lastAttachmentId);
        if (blob) {
          const text = await blob.text();
          log(`âœ… Retrieved blob: ${blob.size} bytes`, 'success');
          log(`   Content: "${text}"`, 'info');
        } else {
          log('âŒ Blob not found', 'error');
        }
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testDelete = async function() {
      if (!window.lastAttachmentId) {
        log('âš ï¸ No attachment ID saved. Run "Save Test Blob" first.', 'error');
        return;
      }
      try {
        await Attachments.deleteAttachment(window.lastAttachmentId);
        log(`âœ… Deleted blob: ${window.lastAttachmentId}`, 'success');
        window.lastAttachmentId = null;
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testList = async function() {
      try {
        const ids = await Attachments.listAttachments();
        log(`âœ… Found ${ids.length} attachments:`, 'success');
        ids.forEach(id => log(`   - ${id}`, 'info'));
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testTotalSize = async function() {
      try {
        const size = await Attachments.getTotalSize();
        const formatted = Attachments.formatFileSize(size);
        log(`âœ… Total size: ${size} bytes (${formatted})`, 'success');
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testUpload = async function() {
      const input = document.getElementById('fileInput');
      if (!input.files || input.files.length === 0) {
        log('âš ï¸ No file selected', 'error');
        return;
      }

      try {
        const file = input.files[0];
        const id = Attachments.generateAttachmentId();
        await Attachments.saveAttachment(id, file);
        window.lastAttachmentId = id;
        log(`âœ… Uploaded: ${file.name} (${Attachments.formatFileSize(file.size)})`, 'success');
        log(`   ID: ${id}`, 'info');
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testDownload = async function() {
      if (!window.lastAttachmentId) {
        log('âš ï¸ No attachment ID saved. Upload a file first.', 'error');
        return;
      }

      try {
        const blob = await Attachments.getAttachment(window.lastAttachmentId);
        if (!blob) {
          log('âŒ Blob not found', 'error');
          return;
        }

        // CrÃ©er un lien de tÃ©lÃ©chargement
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `download_${window.lastAttachmentId}`;
        a.click();
        URL.revokeObjectURL(url);

        log(`âœ… Downloaded blob: ${blob.size} bytes`, 'success');
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testCleanOrphans = async function() {
      try {
        // Mock data (vide pour le test)
        const mockData = { nodes: {} };
        const result = await Attachments.cleanOrphans(mockData);
        log(`âœ… Cleaned ${result.deleted} orphans`, 'success');
        log(`   Freed: ${Attachments.formatFileSize(result.freed)}`, 'info');
      } catch (error) {
        log(`âŒ Error: ${error.message}`, 'error');
      }
    };

    window.testAvailability = function() {
      const available = Attachments.isIndexedDBAvailable();
      if (available) {
        log('âœ… IndexedDB is available', 'success');
      } else {
        log('âŒ IndexedDB is NOT available (private mode?)', 'error');
      }
    };

    window.testFormatSize = function() {
      const tests = [0, 512, 1024, 1536, 1048576, 52428800, 1073741824];
      log('Testing formatFileSize():', 'info');
      tests.forEach(bytes => {
        const formatted = Attachments.formatFileSize(bytes);
        log(`   ${bytes} bytes â†’ ${formatted}`, 'info');
      });
    };

    window.clearOutput = function() {
      document.getElementById('output').innerHTML = '';
    };

    // Auto-init au chargement
    log('ðŸš€ Attachments test page loaded', 'success');
    log('Click "Init DB" to start, or run tests directly', 'info');
  </script>
</body>
</html>
