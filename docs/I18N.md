# Internationalization (i18n) - DeepMemo V0.9

> **Language** : **English** (current version) | [Fran√ßais](I18N.fr.md)

**Creation date**: December 28, 2025
**Version**: V0.9
**Supported languages**: French (FR), English (EN)

---

## Overview

DeepMemo V0.9 implements a complete, lightweight internationalization (i18n) system with no external dependencies. The system allows dynamic switching between French and English, with complete translation of:

- All user interface elements (buttons, labels, placeholders, tooltips)
- System messages (toasts, alerts, confirmations)
- Demo content (26 pedagogical nodes)
- PWA manifests

---

## Architecture

### i18n system files

```
src/js/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ i18n.js              # Main i18n module (~240 lines)
‚îî‚îÄ‚îÄ locales/
    ‚îú‚îÄ‚îÄ fr.js                # French dictionary (~270 lines)
    ‚îî‚îÄ‚îÄ en.js                # English dictionary (~270 lines)

manifest-fr.json             # French PWA manifest
manifest-en.json             # English PWA manifest
```

### Main module (`i18n.js`)

The `src/js/utils/i18n.js` module provides the following functions:

```javascript
// Initialize the i18n system (called at app startup)
await initI18n();

// Translate a key
t('toast.saved');                              // ‚Üí "Saved"
t('app.nodeCounter', {count: 5});             // ‚Üí "5 nodes"
t('toast.dataImported', {count: 10});         // ‚Üí "10 node(s) imported"

// Change language (reloads dictionary and translates DOM)
await setLanguage('en');

// Get current language
getCurrentLanguage();                          // ‚Üí "en" or "fr"

// Re-translate the DOM (useful after dynamic content changes)
translateDOM();
```

---

## Translation dictionaries

### Structure

The dictionaries (`fr.js` and `en.js`) export an object with a hierarchical structure:

```javascript
export default {
  app: {
    title: "DeepMemo",
    tagline: "Your second brain",
    nodeCounter: "{count} node{{count > 1 ? 's' : ''}}"
  },
  actions: {
    newNode: "New node",
    import: "Import",
    export: "Export",
    // ...
  },
  toast: {
    saved: "Saved",
    nodeCreated: "Node created",
    // ... (~73 messages)
  },
  alerts: { /* ... */ },
  confirms: { /* ... */ },
  modals: { /* ... */ },
  placeholders: { /* ... */ },
  labels: { /* ... */ },
  nodeTypes: { /* ... */ },
  messages: { /* ... */ },
  tooltips: { /* ... */ },
  keyboard: { /* ... */ },
  storage: { /* ... */ },
  empty: { /* ... */ },
  meta: { /* ... */ }
};
```

### Interpolation

The i18n system supports two types of interpolation:

**1. Simple variables**: `{variableName}`

```javascript
t('toast.dataImported', {count: 10})
// "dataImported": "{count} node(s) imported"
// ‚Üí "10 node(s) imported"
```

**2. Conditional expressions**: `{{expression}}`

```javascript
t('app.nodeCounter', {count: 5})
// "nodeCounter": "{count} node{{count > 1 ? 's' : ''}}"
// ‚Üí "5 nodes"

t('app.nodeCounter', {count: 1})
// ‚Üí "1 node"
```

Interpolation uses `new Function()` to evaluate expressions dynamically in a secure way (scope limited to provided parameters).

---

## Usage in code

### JavaScript

```javascript
import { t } from '../utils/i18n.js';

// Toast notifications
showToast(t('toast.saved'), 'üíæ');

// Alerts
alert(t('alerts.invalidFile'));

// Confirmations
if (confirm(t('confirms.deleteNode'))) {
  // ...
}

// With interpolation
showToast(t('toast.dataImported', {count: nodeCount}), 'üì•');
```

### HTML

Use `data-i18n-*` attributes to automatically translate elements:

```html
<!-- Text content -->
<h1 data-i18n="app.title">DeepMemo</h1>
<button data-i18n="actions.newNode">New node</button>

<!-- Placeholders -->
<input data-i18n-placeholder="placeholders.search"
       placeholder="Search...">

<!-- Tooltips -->
<button data-i18n-title="tooltips.shareNode"
        title="Copy URL...">üîó</button>

<!-- Meta tags (content attribute) -->
<meta data-i18n-content="meta.description"
      content="Description...">

<!-- Aria labels -->
<div data-i18n-aria-label="labels.informations"
     aria-label="Information">...</div>
```

The DOM is translated automatically:
- On application load (`initI18n()`)
- After each language change (`setLanguage()`)
- Manually with `translateDOM()` if needed

---

## Language detection and selection

### Automatic detection

On first launch (or if `localStorage` is empty):

```javascript
const browserLang = navigator.language.toLowerCase();
const defaultLang = browserLang.startsWith('fr') ? 'fr' : 'en';
```

- `fr`, `fr-FR`, `fr-CA` ‚Üí French
- Everything else ‚Üí English

### Language selector

Users can change language via the selector in the **right panel** (Preferences section):

- **"Fran√ßais"** button: Switch to French
- **"English"** button: Switch to English

The language change:
1. Calls `setLanguage(lang)` which reloads the dictionary
2. Translates the entire DOM with `translateDOM()`
3. Refreshes the interface (tree, current node, right panel)
4. Displays a confirmation toast
5. Saves the preference in `localStorage` (`deepmemo_language`)

### Persistence

The chosen language is saved in `localStorage`:

```javascript
localStorage.setItem('deepmemo_language', 'en');
```

On next load, this preference takes priority over automatic detection.

---

## Demo content

The `src/js/core/default-data.js` file contains **two complete versions** of the demo content (26 pedagogical nodes):

```javascript
import { getCurrentLanguage } from '../utils/i18n.js';

export function getDefaultData() {
  const currentLang = getCurrentLanguage();
  if (currentLang === 'en') {
    return getDefaultDataEN();
  } else {
    return getDefaultDataFR();
  }
}

function getDefaultDataFR() { /* 26 nodes in French */ }
function getDefaultDataEN() { /* 26 nodes in English */ }
```

Both versions cover:
- Welcome and DeepMemo explanation
- Interface description (3 panels)
- Current features (nodes, symlinks, tags, branch mode, attachments, export/import, shortcuts)
- Future directions explored (active nodes, automation, collaboration)
- First steps (getting started guide)

---

## PWA manifests

DeepMemo uses **two separate manifests** for the PWA:

- `manifest-fr.json`: Name and description in French
- `manifest-en.json`: Name and description in English

### Dynamic loading

The `<head>` of `index.html` contains a script that loads the correct manifest based on detected language:

```html
<link rel="manifest" id="app-manifest" href="manifest-fr.json">
<script>
  // Load correct manifest based on language preference
  (function() {
    const savedLang = localStorage.getItem('deepmemo_language');
    const browserLang = navigator.language.toLowerCase().startsWith('fr') ? 'fr' : 'en';
    const lang = savedLang || browserLang;
    const manifestHref = lang === 'en' ? 'manifest-en.json' : 'manifest-fr.json';

    document.getElementById('app-manifest').href = manifestHref;
  })();
</script>
```

**Advantages**:
- Manifest is loaded BEFORE the main JavaScript
- Compatible with offline PWA (Service Worker precaches both manifests)
- Fallback to `manifest-fr.json` if JavaScript is disabled

---

## Service Worker

The Service Worker precaches i18n files for complete offline functionality:

```javascript
// sw.js
const CACHE_VERSION = 'v1.3.0'; // V0.9 - i18n

const PRECACHE_URLS = [
  // ... other files
  '/src/js/utils/i18n.js',
  '/src/js/locales/fr.js',
  '/src/js/locales/en.js',
  '/manifest-fr.json',
  '/manifest-en.json'
];
```

During Service Worker installation:
- All dictionaries are precached
- Language switching works even offline
- Both manifests are available offline

---

## Adding a new language

To add a new language (e.g., Spanish):

### 1. Create the dictionary

Create `src/js/locales/es.js`:

```javascript
export default {
  app: {
    title: "DeepMemo",
    tagline: "Tu segundo cerebro",
    // ...
  },
  // ... copy the complete structure from fr.js or en.js
};
```

### 2. Create the demo content

In `src/js/core/default-data.js`, add:

```javascript
function getDefaultDataES() {
  // Translate the 26 nodes to Spanish
}

export function getDefaultData() {
  const currentLang = getCurrentLanguage();
  if (currentLang === 'es') {
    return getDefaultDataES();
  } else if (currentLang === 'en') {
    return getDefaultDataEN();
  } else {
    return getDefaultDataFR();
  }
}
```

### 3. Create the PWA manifest

Create `manifest-es.json`:

```json
{
  "name": "DeepMemo - Tu segundo cerebro",
  "short_name": "DeepMemo",
  "description": "Sistema de gesti√≥n de conocimientos...",
  "lang": "es",
  // ... other fields
}
```

### 4. Update the Service Worker

In `sw.js`, add to precache:

```javascript
const PRECACHE_URLS = [
  // ... existing
  '/src/js/locales/es.js',
  '/manifest-es.json'
];
```

### 5. Update the language selector

In `src/js/locales/fr.js` and `en.js`, add:

```javascript
labels: {
  // ... existing
  spanish: "Espa√±ol"
}
```

In `src/js/features/editor.js`, add a button in `updateRightPanel()`:

```javascript
<button class="btn btn-small ${currentLang === 'es' ? 'btn-primary' : 'btn-secondary'}"
        style="flex: 1;"
        onclick="window.app.changeLanguage('es')">
  ${t('labels.spanish')}
</button>
```

### 6. Update automatic detection (optional)

In `src/js/utils/i18n.js`, modify `detectLanguage()`:

```javascript
function detectLanguage() {
  const browserLang = navigator.language.toLowerCase();
  if (browserLang.startsWith('fr')) return 'fr';
  if (browserLang.startsWith('es')) return 'es';
  return 'en'; // Fallback
}
```

---

## Best practices

### 1. Use semantic keys

‚ùå Bad:
```javascript
t('button1')
t('text2')
```

‚úÖ Good:
```javascript
t('actions.newNode')
t('toast.saved')
```

### 2. Group by functionality

Organizing keys by logical section (`toast.*`, `actions.*`, `labels.*`, etc.) makes maintenance easier.

### 3. Avoid duplication

If two strings are identical, use the same key:

```javascript
// Instead of duplicating "Parent" in labels.parent and elsewhere
t('labels.parent')  // Reuse everywhere
```

### 4. Test interpolations

Always test with different values:

```javascript
t('app.nodeCounter', {count: 0})  // "0 node"
t('app.nodeCounter', {count: 1})  // "1 node"
t('app.nodeCounter', {count: 5})  // "5 nodes"
```

### 5. Document complex expressions

If a conditional expression is complex, add a comment:

```javascript
// Pluralization: "s" if count > 1
nodeCounter: "{count} node{{count > 1 ? 's' : ''}}"
```

---

## Known limitations

### 1. No advanced pluralization

The system only handles simple cases (singular/plural). For languages with complex pluralization rules (Russian, Polish, Arabic), a dedicated library would be needed.

**Current solution**: Inline conditional expressions
**Future improvement**: Integration of a lightweight pluralization library (Intl.PluralRules)

### 2. No gender handling

French has genders (masculine/feminine), which can pose problems:

```javascript
// "cr√©√©" vs "cr√©√©e" depending on gender
labels.created: "Cr√©√©"  // Neutral by default
```

**Current solution**: Use the most common form
**Future improvement**: Support for gendered variants if needed

### 3. No number/date formatting

Numbers and dates use the browser's `toLocaleString()`, not the i18n system:

```javascript
new Date(node.created).toLocaleString()  // Browser format
```

**Current solution**: Delegate to the browser (sufficient for DeepMemo)
**Future improvement**: Integration of Intl.DateTimeFormat if needed

### 4. Dictionary loading

Dictionaries are loaded dynamically via `import()`, which can create a slight delay when changing language.

**Current solution**: Acceptable for DeepMemo (a few ms)
**Future improvement**: Preload all dictionaries at startup

---

## Recommended tests

### Functional tests

1. **Automatic detection**
   - First visit ‚Üí Language detected according to `navigator.language`
   - FR browser ‚Üí Interface in French
   - EN browser ‚Üí Interface in English

2. **Language selector**
   - Click "English" ‚Üí Interface switches to English
   - Click "Fran√ßais" ‚Üí Interface switches to French
   - Confirmation toast displayed: "Langue modifi√©e" / "Language changed"

3. **Persistence**
   - Change language ‚Üí Refresh page ‚Üí Language preserved
   - Check `localStorage.getItem('deepmemo_language')`

4. **Demo content**
   - Clear localStorage ‚Üí Refresh
   - FR language ‚Üí Demo content in French (26 nodes)
   - Switch to EN ‚Üí Demo content unchanged (existing nodes keep their content)
   - Clear localStorage again in English ‚Üí Demo content in English

5. **PWA manifests**
   - FR language ‚Üí `manifest-fr.json` loaded (check DevTools ‚Üí Application ‚Üí Manifest)
   - EN language ‚Üí `manifest-en.json` loaded
   - Install PWA in FR ‚Üí Name "DeepMemo - Ton second cerveau"
   - Install PWA in EN ‚Üí Name "DeepMemo - Your second brain"

6. **Offline mode**
   - Enable Service Worker
   - Go offline (DevTools ‚Üí Network ‚Üí Offline)
   - Change language ‚Üí Should work (dictionaries precached)
   - Refresh page ‚Üí Interface loads correctly

### Interpolation tests

```javascript
// In browser console
await app.changeLanguage('en');
app.t('app.nodeCounter', {count: 0});  // "0 nodes"
app.t('app.nodeCounter', {count: 1});  // "1 node"
app.t('app.nodeCounter', {count: 5});  // "5 nodes"
app.t('toast.dataImported', {count: 10}); // "10 node(s) imported"
```

### Browser compatibility tests

- ‚úÖ Chrome/Edge (tested)
- ‚úÖ Firefox (tested)
- ‚úÖ Safari (tested)
- ‚úÖ Mobile (Chrome/Safari)

---

## Final corrections (December 28, 2025)

### Post-migration global verification

After completing the i18n system migration, a global verification was performed following user reports of untranslated strings.

### Search methodology

Using grep with targeted patterns:
1. `toggleView|√âditer|Afficher` - Search for toggle buttons
2. `Copier|T√©l√©charger|Supprimer` - Search for attachment tooltips
3. `(textContent|innerHTML|title|placeholder|confirm|alert)\s*=\s*['\"]` - Exhaustive search

### Forgotten strings identified: 15 total

#### `src/js/features/editor.js` (10 strings)

**Line 229** - Breadcrumb home tooltip:
```javascript
// Before: title="Retour √† la racine"
// After: title="${t('tooltips.goToRoot')}"
```

**Line 259** - Breadcrumb parent tooltip:
```javascript
// Before: title="Remonter au parent"
// After: title="${t('tooltips.goToParent')}"
```

**Lines 451, 455-457** - Attachment tooltips:
```javascript
// Before: title="ID de l'attachment"
// After: title="${t('tooltips.attachmentId')}"

// Before: title="Copier la syntaxe markdown"
// After: title="${t('tooltips.copyMarkdown')}"

// Before: title="T√©l√©charger"
// After: title="${t('tooltips.download')}"

// Before: title="Supprimer"
// After: title="${t('tooltips.deleteFile')}"
```

**Lines 732, 756, 751** - Toggle button and empty content:
```javascript
// Before: toggleBtn.textContent = '‚úèÔ∏è √âditer';
// After: toggleBtn.textContent = `‚úèÔ∏è ${t('actions.edit')}`;

// Before: toggleBtn.textContent = 'üëÅÔ∏è Afficher';
// After: toggleBtn.textContent = `üëÅÔ∏è ${t('actions.view')}`;

// Before: '<em>Aucun contenu</em>'
// After: `<em>${t('messages.emptyContent')}</em>`
```

**Lines 805-806** - Delete confirmations:
```javascript
// Before: 'Supprimer ce lien symbolique ?'
// After: t('confirms.deleteSymlink')

// Before: 'Supprimer ce n≈ìud et tous ses enfants ?'
// After: t('confirms.deleteNode')
```

#### `src/js/features/tree.js` (2 strings)

**Line 184** - Circular symlink badge:
```javascript
// Before: ' (circulaire)'
// After: ' (' + t('nodeTypes.badge.circular') + ')'
```

**Line 224** - Broken symlink badge:
```javascript
// Before: ' (lien cass√©)'
// After: ' (' + t('nodeTypes.badge.broken') + ')'
```

#### `src/js/features/search.js` (2 strings + 1 import)

**Line 8** - Added import:
```javascript
import { t } from '../utils/i18n.js';
```

**Line 61** - Empty search message:
```javascript
// Before: '<div>Tape pour rechercher dans tes n≈ìuds</div>'
// After: `<div>${t('modals.search.emptyHint')}</div>`
```

**Line 132** - No results message:
```javascript
// Before: '<div>Aucun r√©sultat trouv√©</div>'
// After: `<div>${t('modals.search.noResults')}</div>`
```

#### `src/js/features/tags.js` (1 string)

**Line 78** - Tag input placeholder:
```javascript
// Before: input.placeholder = '+ tag';
// After: input.placeholder = t('placeholders.tagInput');
```

### Result

‚úÖ **100% of the interface translated** - No hardcoded strings remaining in JavaScript code
‚úÖ **4 files corrected** - editor.js, tree.js, search.js, tags.js
‚úÖ **15 strings migrated** - All now using `t()` calls

---

## Conclusion

The DeepMemo V0.9 i18n system is:

‚úÖ **Complete**: All UI, system messages, and demo content
‚úÖ **Lightweight**: No external dependencies (~240 lines of code)
‚úÖ **Performant**: Dynamic dictionary loading, precaching for offline
‚úÖ **Extensible**: Easy to add new languages
‚úÖ **PWA-compatible**: Multilingual manifests + Service Worker
‚úÖ **Easy to maintain**: Clear structure, semantic keys, separate files
‚úÖ **100% translated**: Exhaustive verification completed (Dec 28, 2025)

For any questions or improvements, refer to the source code in `src/js/utils/i18n.js` and the dictionaries in `src/js/locales/`.
