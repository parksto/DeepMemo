# Internationalisation (i18n) - DeepMemo V0.9

**Date de cr√©ation** : 28 d√©cembre 2025
**Version** : V0.9
**Langues support√©es** : Fran√ßais (FR), English (EN)

---

## Vue d'ensemble

DeepMemo V0.9 impl√©mente un syst√®me d'internationalisation (i18n) complet, l√©ger et sans d√©pendances externes. Le syst√®me permet de basculer dynamiquement entre le fran√ßais et l'anglais, avec traduction compl√®te de :

- Toute l'interface utilisateur (boutons, labels, placeholders, tooltips)
- Les messages syst√®me (toasts, alerts, confirmations)
- Le contenu de d√©monstration (26 n≈ìuds p√©dagogiques)
- Les manifests PWA

---

## Architecture

### Fichiers du syst√®me i18n

```
src/js/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ i18n.js              # Module i18n principal (~240 lignes)
‚îî‚îÄ‚îÄ locales/
    ‚îú‚îÄ‚îÄ fr.js                # Dictionnaire fran√ßais (~270 lignes)
    ‚îî‚îÄ‚îÄ en.js                # Dictionnaire anglais (~270 lignes)

manifest-fr.json             # Manifest PWA fran√ßais
manifest-en.json             # Manifest PWA anglais
```

### Module principal (`i18n.js`)

Le module `src/js/utils/i18n.js` fournit les fonctions suivantes :

```javascript
// Initialiser le syst√®me i18n (appel√© au d√©marrage de l'app)
await initI18n();

// Traduire une cl√©
t('toast.saved');                              // ‚Üí "Saved"
t('app.nodeCounter', {count: 5});             // ‚Üí "5 nodes"
t('toast.dataImported', {count: 10});         // ‚Üí "10 node(s) imported"

// Changer de langue (recharge le dictionnaire et traduit le DOM)
await setLanguage('en');

// Obtenir la langue actuelle
getCurrentLanguage();                          // ‚Üí "en" ou "fr"

// Re-traduire le DOM (utile apr√®s changement dynamique de contenu)
translateDOM();
```

---

## Dictionnaires de traduction

### Structure

Les dictionnaires (`fr.js` et `en.js`) exportent un objet avec une structure hi√©rarchique :

```javascript
export default {
  app: {
    title: "DeepMemo",
    tagline: "Your second brain",
    nodeCounter: "{count} node{{count > 1 ? 's' : ''}}"
  },
  actions: {
    newNode: "New node",
    import: "Import",
    export: "Export",
    // ...
  },
  toast: {
    saved: "Saved",
    nodeCreated: "Node created",
    // ... (~73 messages)
  },
  alerts: { /* ... */ },
  confirms: { /* ... */ },
  modals: { /* ... */ },
  placeholders: { /* ... */ },
  labels: { /* ... */ },
  nodeTypes: { /* ... */ },
  messages: { /* ... */ },
  tooltips: { /* ... */ },
  keyboard: { /* ... */ },
  storage: { /* ... */ },
  empty: { /* ... */ },
  meta: { /* ... */ }
};
```

### Interpolation

Le syst√®me i18n supporte deux types d'interpolation :

**1. Variables simples** : `{variableName}`

```javascript
t('toast.dataImported', {count: 10})
// "dataImported": "{count} node(s) imported"
// ‚Üí "10 node(s) imported"
```

**2. Expressions conditionnelles** : `{{expression}}`

```javascript
t('app.nodeCounter', {count: 5})
// "nodeCounter": "{count} node{{count > 1 ? 's' : ''}}"
// ‚Üí "5 nodes"

t('app.nodeCounter', {count: 1})
// ‚Üí "1 node"
```

L'interpolation utilise `new Function()` pour √©valuer les expressions dynamiquement de mani√®re s√©curis√©e (scope limit√© aux param√®tres fournis).

---

## Utilisation dans le code

### JavaScript

```javascript
import { t } from '../utils/i18n.js';

// Toast notifications
showToast(t('toast.saved'), 'üíæ');

// Alerts
alert(t('alerts.invalidFile'));

// Confirmations
if (confirm(t('confirms.deleteNode'))) {
  // ...
}

// Avec interpolation
showToast(t('toast.dataImported', {count: nodeCount}), 'üì•');
```

### HTML

Utiliser les attributs `data-i18n-*` pour traduire automatiquement les √©l√©ments :

```html
<!-- Contenu textuel -->
<h1 data-i18n="app.title">DeepMemo</h1>
<button data-i18n="actions.newNode">Nouveau n≈ìud</button>

<!-- Placeholders -->
<input data-i18n-placeholder="placeholders.search"
       placeholder="Rechercher...">

<!-- Tooltips -->
<button data-i18n-title="tooltips.shareNode"
        title="Copier l'URL...">üîó</button>

<!-- M√©ta tags (content attribute) -->
<meta data-i18n-content="meta.description"
      content="Description...">

<!-- Aria labels -->
<div data-i18n-aria-label="labels.informations"
     aria-label="Informations">...</div>
```

Le DOM est traduit automatiquement :
- Au chargement de l'application (`initI18n()`)
- Apr√®s chaque changement de langue (`setLanguage()`)
- Manuellement avec `translateDOM()` si n√©cessaire

---

## D√©tection et s√©lection de la langue

### D√©tection automatique

Au premier lancement (ou si `localStorage` est vide) :

```javascript
const browserLang = navigator.language.toLowerCase();
const defaultLang = browserLang.startsWith('fr') ? 'fr' : 'en';
```

- `fr`, `fr-FR`, `fr-CA` ‚Üí Fran√ßais
- Tout le reste ‚Üí Anglais

### S√©lecteur de langue

L'utilisateur peut changer de langue via le s√©lecteur dans le **right panel** (section Pr√©f√©rences) :

- Bouton **"Fran√ßais"** : Change en fran√ßais
- Bouton **"English"** : Change en anglais

Le changement de langue :
1. Appelle `setLanguage(lang)` qui recharge le dictionnaire
2. Traduit tout le DOM avec `translateDOM()`
3. Rafra√Æchit l'interface (arbre, n≈ìud actuel, right panel)
4. Affiche un toast de confirmation
5. Sauvegarde la pr√©f√©rence dans `localStorage` (`deepmemo_language`)

### Persistance

La langue choisie est sauvegard√©e dans `localStorage` :

```javascript
localStorage.setItem('deepmemo_language', 'en');
```

Au prochain chargement, cette pr√©f√©rence est prioritaire sur la d√©tection automatique.

---

## Contenu de d√©monstration

Le fichier `src/js/core/default-data.js` contient **deux versions compl√®tes** du contenu de d√©monstration (26 n≈ìuds p√©dagogiques) :

```javascript
import { getCurrentLanguage } from '../utils/i18n.js';

export function getDefaultData() {
  const currentLang = getCurrentLanguage();
  if (currentLang === 'en') {
    return getDefaultDataEN();
  } else {
    return getDefaultDataFR();
  }
}

function getDefaultDataFR() { /* 26 n≈ìuds en fran√ßais */ }
function getDefaultDataEN() { /* 26 n≈ìuds en anglais */ }
```

Les deux versions couvrent :
- Accueil et explication de DeepMemo
- Description de l'interface (3 panneaux)
- Fonctionnalit√©s actuelles (n≈ìuds, symlinks, tags, mode branche, attachments, export/import, raccourcis)
- Directions futures explor√©es (n≈ìuds actifs, automation, collaboration)
- Premiers pas (guide de d√©marrage)

---

## Manifests PWA

DeepMemo utilise **deux manifests** s√©par√©s pour le PWA :

- `manifest-fr.json` : Nom et description en fran√ßais
- `manifest-en.json` : Nom et description en anglais

### Chargement dynamique

Le `<head>` de `index.html` contient un script qui charge le bon manifest selon la langue d√©tect√©e :

```html
<link rel="manifest" id="app-manifest" href="manifest-fr.json">
<script>
  // Load correct manifest based on language preference
  (function() {
    const savedLang = localStorage.getItem('deepmemo_language');
    const browserLang = navigator.language.toLowerCase().startsWith('fr') ? 'fr' : 'en';
    const lang = savedLang || browserLang;
    const manifestHref = lang === 'en' ? 'manifest-en.json' : 'manifest-fr.json';

    document.getElementById('app-manifest').href = manifestHref;
  })();
</script>
```

**Avantages** :
- Le manifest est charg√© AVANT le JavaScript principal
- Compatible PWA offline (Service Worker pr√©cache les deux manifests)
- Fallback sur `manifest-fr.json` si JavaScript d√©sactiv√©

---

## Service Worker

Le Service Worker pr√©cache les fichiers i18n pour un fonctionnement offline complet :

```javascript
// sw.js
const CACHE_VERSION = 'v1.3.0'; // V0.9 - i18n

const PRECACHE_URLS = [
  // ... autres fichiers
  '/src/js/utils/i18n.js',
  '/src/js/locales/fr.js',
  '/src/js/locales/en.js',
  '/manifest-fr.json',
  '/manifest-en.json'
];
```

Lors de l'installation du Service Worker :
- Tous les dictionnaires sont pr√©cach√©s
- Le changement de langue fonctionne m√™me offline
- Les deux manifests sont disponibles offline

---

## Ajout d'une nouvelle langue

Pour ajouter une nouvelle langue (ex: Espagnol) :

### 1. Cr√©er le dictionnaire

Cr√©er `src/js/locales/es.js` :

```javascript
export default {
  app: {
    title: "DeepMemo",
    tagline: "Tu segundo cerebro",
    // ...
  },
  // ... copier la structure compl√®te de fr.js ou en.js
};
```

### 2. Cr√©er le contenu de d√©mo

Dans `src/js/core/default-data.js`, ajouter :

```javascript
function getDefaultDataES() {
  // Traduire les 26 n≈ìuds en espagnol
}

export function getDefaultData() {
  const currentLang = getCurrentLanguage();
  if (currentLang === 'es') {
    return getDefaultDataES();
  } else if (currentLang === 'en') {
    return getDefaultDataEN();
  } else {
    return getDefaultDataFR();
  }
}
```

### 3. Cr√©er le manifest PWA

Cr√©er `manifest-es.json` :

```json
{
  "name": "DeepMemo - Tu segundo cerebro",
  "short_name": "DeepMemo",
  "description": "Sistema de gesti√≥n de conocimientos...",
  "lang": "es",
  // ... autres champs
}
```

### 4. Mettre √† jour le Service Worker

Dans `sw.js`, ajouter au pr√©cache :

```javascript
const PRECACHE_URLS = [
  // ... existant
  '/src/js/locales/es.js',
  '/manifest-es.json'
];
```

### 5. Mettre √† jour le s√©lecteur de langue

Dans `src/js/locales/fr.js` et `en.js`, ajouter :

```javascript
labels: {
  // ... existant
  spanish: "Espa√±ol"
}
```

Dans `src/js/features/editor.js`, ajouter un bouton dans `updateRightPanel()` :

```javascript
<button class="btn btn-small ${currentLang === 'es' ? 'btn-primary' : 'btn-secondary'}"
        style="flex: 1;"
        onclick="window.app.changeLanguage('es')">
  ${t('labels.spanish')}
</button>
```

### 6. Mettre √† jour la d√©tection automatique (optionnel)

Dans `src/js/utils/i18n.js`, modifier `detectLanguage()` :

```javascript
function detectLanguage() {
  const browserLang = navigator.language.toLowerCase();
  if (browserLang.startsWith('fr')) return 'fr';
  if (browserLang.startsWith('es')) return 'es';
  return 'en'; // Fallback
}
```

---

## Bonnes pratiques

### 1. Utiliser des cl√©s s√©mantiques

‚ùå Mauvais :
```javascript
t('button1')
t('text2')
```

‚úÖ Bon :
```javascript
t('actions.newNode')
t('toast.saved')
```

### 2. Grouper par fonctionnalit√©

Organiser les cl√©s par section logique (`toast.*`, `actions.*`, `labels.*`, etc.) facilite la maintenance.

### 3. √âviter la duplication

Si deux strings sont identiques, utiliser la m√™me cl√© :

```javascript
// Au lieu de dupliquer "Parent" dans labels.parent et autre part
t('labels.parent')  // R√©utiliser partout
```

### 4. Tester les interpolations

Toujours tester avec diff√©rentes valeurs :

```javascript
t('app.nodeCounter', {count: 0})  // "0 node"
t('app.nodeCounter', {count: 1})  // "1 node"
t('app.nodeCounter', {count: 5})  // "5 nodes"
```

### 5. Documenter les expressions complexes

Si une expression conditionnelle est complexe, ajouter un commentaire :

```javascript
// Pluralization: "s" if count > 1
nodeCounter: "{count} node{{count > 1 ? 's' : ''}}"
```

---

## Limitations connues

### 1. Pas de pluralisation avanc√©e

Le syst√®me g√®re seulement les cas simples (singulier/pluriel). Pour des langues avec des r√®gles de pluralisation complexes (russe, polonais, arabe), il faudrait une lib d√©di√©e.

**Solution actuelle** : Expressions conditionnelles inline
**Am√©lioration future** : Int√©gration d'une lib de pluralisation l√©g√®re (Intl.PluralRules)

### 2. Pas de gestion des genres

Le fran√ßais a des genres (masculin/f√©minin), ce qui peut poser probl√®me :

```javascript
// "cr√©√©" vs "cr√©√©e" selon le genre
labels.created: "Cr√©√©"  // Neutre par d√©faut
```

**Solution actuelle** : Utiliser la forme la plus courante
**Am√©lioration future** : Support des variantes genr√©es si n√©cessaire

### 3. Pas de formatage de nombres/dates

Les nombres et dates utilisent `toLocaleString()` du navigateur, pas le syst√®me i18n :

```javascript
new Date(node.created).toLocaleString()  // Format du navigateur
```

**Solution actuelle** : D√©l√©guer au navigateur (suffisant pour DeepMemo)
**Am√©lioration future** : Int√©gration de Intl.DateTimeFormat si besoin

### 4. Chargement des dictionnaires

Les dictionnaires sont charg√©s dynamiquement via `import()`, ce qui peut cr√©er un l√©ger d√©lai au changement de langue.

**Solution actuelle** : Acceptable pour DeepMemo (quelques ms)
**Am√©lioration future** : Pr√©charger tous les dictionnaires au d√©marrage

---

## Tests recommand√©s

### Tests fonctionnels

1. **D√©tection automatique**
   - Premi√®re visite ‚Üí Langue d√©tect√©e selon `navigator.language`
   - Navigateur FR ‚Üí Interface en fran√ßais
   - Navigateur EN ‚Üí Interface en anglais

2. **S√©lecteur de langue**
   - Cliquer "English" ‚Üí Interface bascule en anglais
   - Cliquer "Fran√ßais" ‚Üí Interface bascule en fran√ßais
   - Toast de confirmation affich√© : "Langue modifi√©e" / "Language changed"

3. **Persistance**
   - Changer de langue ‚Üí Rafra√Æchir la page ‚Üí Langue conserv√©e
   - V√©rifier `localStorage.getItem('deepmemo_language')`

4. **Contenu de d√©mo**
   - Vider localStorage ‚Üí Rafra√Æchir
   - Langue FR ‚Üí Contenu d√©mo en fran√ßais (26 n≈ìuds)
   - Changer en EN ‚Üí Contenu d√©mo inchang√© (nodes existants gardent leur contenu)
   - Vider √† nouveau localStorage en anglais ‚Üí Contenu d√©mo en anglais

5. **Manifests PWA**
   - Langue FR ‚Üí `manifest-fr.json` charg√© (v√©rifier DevTools ‚Üí Application ‚Üí Manifest)
   - Langue EN ‚Üí `manifest-en.json` charg√©
   - Installer PWA en FR ‚Üí Nom "DeepMemo - Ton second cerveau"
   - Installer PWA en EN ‚Üí Nom "DeepMemo - Your second brain"

6. **Mode offline**
   - Activer Service Worker
   - Mettre hors ligne (DevTools ‚Üí Network ‚Üí Offline)
   - Changer de langue ‚Üí Doit fonctionner (dictionnaires pr√©cach√©s)
   - Rafra√Æchir la page ‚Üí Interface charge correctement

### Tests d'interpolation

```javascript
// Dans la console navigateur
await app.changeLanguage('en');
app.t('app.nodeCounter', {count: 0});  // "0 nodes"
app.t('app.nodeCounter', {count: 1});  // "1 node"
app.t('app.nodeCounter', {count: 5});  // "5 nodes"
app.t('toast.dataImported', {count: 10}); // "10 node(s) imported"
```

### Tests de compatibilit√© navigateur

- ‚úÖ Chrome/Edge (test√©)
- ‚úÖ Firefox (test√©)
- ‚úÖ Safari (test√©)
- ‚úÖ Mobile (Chrome/Safari)

---

## Corrections finales (28 d√©cembre 2025)

### V√©rification globale post-migration

Apr√®s la migration compl√®te du syst√®me i18n, une v√©rification globale a √©t√© effectu√©e suite au signalement de strings non traduites par l'utilisateur.

### M√©thodologie de recherche

Utilisation de grep avec patterns cibl√©s :
1. `toggleView|√âditer|Afficher` - Recherche des boutons toggle
2. `Copier|T√©l√©charger|Supprimer` - Recherche des tooltips attachments
3. `(textContent|innerHTML|title|placeholder|confirm|alert)\s*=\s*['\"]` - Recherche exhaustive

### Strings oubli√©es identifi√©es : 15 au total

#### `src/js/features/editor.js` (10 strings)

**Ligne 229** - Breadcrumb home tooltip :
```javascript
// Avant : title="Retour √† la racine"
// Apr√®s : title="${t('tooltips.goToRoot')}"
```

**Ligne 259** - Breadcrumb parent tooltip :
```javascript
// Avant : title="Remonter au parent"
// Apr√®s : title="${t('tooltips.goToParent')}"
```

**Lignes 451, 455-457** - Tooltips attachments :
```javascript
// Avant : title="ID de l'attachment"
// Apr√®s : title="${t('tooltips.attachmentId')}"

// Avant : title="Copier la syntaxe markdown"
// Apr√®s : title="${t('tooltips.copyMarkdown')}"

// Avant : title="T√©l√©charger"
// Apr√®s : title="${t('tooltips.download')}"

// Avant : title="Supprimer"
// Apr√®s : title="${t('tooltips.deleteFile')}"
```

**Lignes 732, 756, 751** - Toggle button et contenu vide :
```javascript
// Avant : toggleBtn.textContent = '‚úèÔ∏è √âditer';
// Apr√®s : toggleBtn.textContent = `‚úèÔ∏è ${t('actions.edit')}`;

// Avant : toggleBtn.textContent = 'üëÅÔ∏è Afficher';
// Apr√®s : toggleBtn.textContent = `üëÅÔ∏è ${t('actions.view')}`;

// Avant : '<em>Aucun contenu</em>'
// Apr√®s : `<em>${t('messages.emptyContent')}</em>`
```

**Lignes 805-806** - Confirmations de suppression :
```javascript
// Avant : 'Supprimer ce lien symbolique ?'
// Apr√®s : t('confirms.deleteSymlink')

// Avant : 'Supprimer ce n≈ìud et tous ses enfants ?'
// Apr√®s : t('confirms.deleteNode')
```

#### `src/js/features/tree.js` (2 strings)

**Ligne 184** - Badge symlink circulaire :
```javascript
// Avant : ' (circulaire)'
// Apr√®s : ' (' + t('nodeTypes.badge.circular') + ')'
```

**Ligne 224** - Badge symlink cass√© :
```javascript
// Avant : ' (lien cass√©)'
// Apr√®s : ' (' + t('nodeTypes.badge.broken') + ')'
```

#### `src/js/features/search.js` (2 strings + 1 import)

**Ligne 8** - Import ajout√© :
```javascript
import { t } from '../utils/i18n.js';
```

**Ligne 61** - Message recherche vide :
```javascript
// Avant : '<div>Tape pour rechercher dans tes n≈ìuds</div>'
// Apr√®s : `<div>${t('modals.search.emptyHint')}</div>`
```

**Ligne 132** - Message aucun r√©sultat :
```javascript
// Avant : '<div>Aucun r√©sultat trouv√©</div>'
// Apr√®s : `<div>${t('modals.search.noResults')}</div>`
```

#### `src/js/features/tags.js` (1 string)

**Ligne 78** - Placeholder input tag :
```javascript
// Avant : input.placeholder = '+ tag';
// Apr√®s : input.placeholder = t('placeholders.tagInput');
```

### R√©sultat

‚úÖ **100% de l'interface traduite** - Aucune string hardcod√©e restante dans le code JavaScript
‚úÖ **4 fichiers corrig√©s** - editor.js, tree.js, search.js, tags.js
‚úÖ **15 strings migr√©es** - Toutes maintenant avec appels `t()`

---

## Conclusion

Le syst√®me i18n de DeepMemo V0.9 est :

‚úÖ **Complet** : Toute l'UI, les messages syst√®me, et le contenu d√©mo
‚úÖ **L√©ger** : Aucune d√©pendance externe (~240 lignes de code)
‚úÖ **Performant** : Chargement dynamique des dictionnaires, pr√©cache pour offline
‚úÖ **Extensible** : Facile d'ajouter de nouvelles langues
‚úÖ **PWA-compatible** : Manifests multilingues + Service Worker
‚úÖ **Simple √† maintenir** : Structure claire, cl√©s s√©mantiques, fichiers s√©par√©s
‚úÖ **100% traduit** : V√©rification exhaustive effectu√©e (28 d√©c 2025)

Pour toute question ou am√©lioration, consulter le code source dans `src/js/utils/i18n.js` et les dictionnaires dans `src/js/locales/`.
